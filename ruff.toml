# Ruff Configuration
# Python linting and formatting tool
# Docs: https://docs.astral.sh/ruff/

# Target Python 3.10+
target-version = "py310"

# Max line length (Black standard)
line-length = 88

# Enable auto-fixing
fix = true

[lint]
# Enable comprehensive rule sets
select = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # Pyflakes
    "I",      # isort (import sorting)
    "N",      # pep8-naming
    "D",      # pydocstyle (docstrings)
    "UP",     # pyupgrade (modern Python syntax)
    "YTT",    # flake8-2020
    "ANN",    # flake8-annotations (type hints)
    "S",      # flake8-bandit (security)
    "BLE",    # flake8-blind-except
    "FBT",    # flake8-boolean-trap
    "B",      # flake8-bugbear
    "A",      # flake8-builtins
    "COM",    # flake8-commas
    "C4",     # flake8-comprehensions
    "DTZ",    # flake8-datetimez
    "T10",    # flake8-debugger
    "EM",     # flake8-errmsg
    "ISC",    # flake8-implicit-str-concat
    "ICN",    # flake8-import-conventions
    "G",      # flake8-logging-format
    "INP",    # flake8-no-pep420
    "PIE",    # flake8-pie
    "T20",    # flake8-print
    "PYI",    # flake8-pyi
    "PT",     # flake8-pytest-style
    "Q",      # flake8-quotes
    "RSE",    # flake8-raise
    "RET",    # flake8-return
    "SLF",    # flake8-self
    "SIM",    # flake8-simplify
    "TID",    # flake8-tidy-imports
    "TCH",    # flake8-type-checking
    "ARG",    # flake8-unused-arguments
    "PTH",    # flake8-use-pathlib
    "ERA",    # eradicate (commented-out code)
    "PL",     # Pylint
    "TRY",    # tryceratops
    "RUF",    # Ruff-specific rules
]

# Rules to ignore (with justification)
ignore = [
    "D100",   # Missing docstring in public module (not always needed)
    "D104",   # Missing docstring in public package (not always needed)
    "D105",   # Missing docstring in magic method (not always needed)
    "D106",   # Missing docstring in public nested class (not always needed)
    "D200",   # One-line docstring fit on one line (formatter handles)
    "D212",   # Multi-line docstring summary should start at first line (style preference)
    "ANN401", # Dynamically typed expressions (Any) are allowed
    "S101",   # Use of assert (needed for tests)
    "T201",   # print() allowed (for scripts and debugging)
    "FBT001", # Boolean positional arg (sometimes needed)
    "FBT002", # Boolean default arg (sometimes needed)
    "COM812", # Missing trailing comma (conflicts with formatter)
    "Q000",   # Single quotes (let formatter handle)
    "Q003",   # Avoidable escaped quotes (let formatter handle)
    "G004",   # f-strings in logging (readable, minor perf concern)
    "TRY003", # Long exception messages (style preference)
    "EM101",  # Exception string literals (style preference)
    "EM102",  # Exception f-string literals (style preference)
    "TRY002", # Create custom exception class (over-engineering for small projects)
    "PLR2004", # Magic values in comparisons (sometimes clearer inline)
    "PLR0915", # Too many statements (complex functions sometimes needed)
    "PLR0912", # Too many branches (complex functions sometimes needed)
    "PLR0911", # Too many return statements (sometimes clearer)
    "D411",   # Missing blank line before section (style preference)
    "D205",   # 1 blank line required between summary and description (style)
    "D415",   # First line should end with punctuation (style)
    "TRY400", # Use logging.exception instead of logging.error (minor)
    "G201",   # Use logging.exception instead of .error with exc_info (minor)
    "N806",   # Variable should be lowercase (sometimes needed for constants)
    "PLR1730", # Replace if-else with max/min (style preference)
    "PTH118", # os.path.join should use Path (Django settings pattern)
]

# Allow auto-fixing for these rules
fixable = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # Pyflakes
    "I",      # isort
    "UP",     # pyupgrade
    "COM",    # commas
    "C4",     # comprehensions
    "ISC",    # implicit string concatenation
    "PIE",    # flake8-pie
    "Q",      # quotes
    "RSE",    # raise
    "RET",    # return
    "SIM",    # simplify
    "ERA",    # eradicate
    "RUF",    # Ruff-specific
]

[lint.per-file-ignores]
# Django admin files have mutable class attributes by design
"backend/**/admin.py" = [
    "RUF012", # Mutable class attributes are normal in Django admin
    "D101",   # Docstrings not required for admin classes
]

# Django apps.py files
"backend/**/apps.py" = [
    "D101",   # Docstrings not required for AppConfig
]

# Django management commands
"backend/**/management/commands/*.py" = [
    "D101",   # Docstrings not required for Command classes
    "D102",   # Docstrings not required for handle method
    "ARG002", # Unused args/kwargs are common in Command.handle
    "ANN001", # Type annotations not always needed for parser args
    "ANN002", # *args annotation not needed
    "ANN003", # **kwargs annotation not needed
    "ANN201", # Return type annotations relaxed
    "PLC0415", # Import inside function OK (Django lazy loading)
    "TRY301", # Abstract raise to inner function (not always applicable)
    "TRY300", # Move to else block (style preference)
    "PTH123", # open() is fine (Path.open() not always needed)
    "E501",   # Line length relaxed
    "BLE001", # Blind except for error handling
    "B904",   # Raise from not required
]

# Django migrations are auto-generated
"backend/**/migrations/*.py" = [
    "D101",   # Docstrings not required
    "RUF012", # Mutable class attributes are normal
    "E501",   # Line length relaxed for migrations
]

# Django models can have class attributes
"backend/**/models.py" = [
    "RUF012", # Mutable class attributes are normal in Django models
    "D101",   # Docstrings relaxed for model classes
    "ANN204", # Return type relaxed for __str__, __repr__
    "E501",   # Line length relaxed
]

# Prompts file contains long text strings
"backend/api/prompts.py" = [
    "E501",   # Line length relaxed for prompt text
]

# Django serializers can have class attributes
"backend/**/serializers.py" = [
    "RUF012", # Mutable class attributes are normal in serializers
    "D101",   # Docstrings not required for serializer classes
    "D102",   # Docstrings not required for serializer methods
    "ANN001", # Type annotations relaxed
    "ANN201", # Return type relaxed
]

# Django standard files (manage.py, wsgi.py, asgi.py, urls.py)
"backend/manage.py" = [
    "PLC0415", # Import inside function (Django pattern)
    "ANN201",  # Return type not needed for main()
]

"backend/backend/urls.py" = [
    "D103",   # Docstring not needed for serve_react helper
    "ANN001", # Type annotations relaxed for view helper
    "ANN201", # Return type relaxed for view helper
]

# Views can be complex (both original views.py and views/ package)
"backend/api/views.py" = [
    "D101",   # Docstrings not required for viewset classes
    "D102",   # Docstrings not required for view methods (self-documenting)
    "D103",   # Docstrings not required for helper functions
    "E501",   # Line length relaxed for complex queries
    "E722",   # Bare except for resilience
    "PLC0415", # Import inside function OK (lazy imports)
    "ANN001", # Type annotations relaxed for DRF views
    "ANN002", # *args annotation not needed
    "ANN003", # **kwargs annotation not needed
    "ANN201", # Return type relaxed for DRF views
    "ANN204", # Return type relaxed for special methods
    "ARG002", # Unused method argument (DRF pattern)
    "RUF012", # Mutable class attributes (DRF pattern)
    "BLE001", # Blind except for resilience
    "S110",   # try-except-pass for resilience
]
"backend/api/views/*.py" = [
    "D101",   # Docstrings not required for viewset classes
    "D102",   # Docstrings not required for view methods (self-documenting)
    "D103",   # Docstrings not required for helper functions
    "E501",   # Line length relaxed for complex queries
    "E722",   # Bare except for resilience
    "PLC0415", # Import inside function OK (lazy imports)
    "ANN001", # Type annotations relaxed for DRF views
    "ANN002", # *args annotation not needed
    "ANN003", # **kwargs annotation not needed
    "ANN201", # Return type relaxed for DRF views
    "ANN204", # Return type relaxed for special methods
    "ARG002", # Unused method argument (DRF pattern)
    "RUF012", # Mutable class attributes (DRF pattern)
    "RUF022", # __all__ sorting not required (grouped by domain)
    "BLE001", # Blind except for resilience
    "S110",   # try-except-pass for resilience
    "TID252", # Relative imports from parent allowed in views package
]

# Background tasks can be complex
"backend/api/background_tasks.py" = [
    "E501",   # Line length relaxed for complex operations
    "E722",   # Bare except for resilience
    "PLC0415", # Import inside function OK (thread-safe imports)
    "BLE001", # Blind except sometimes needed for resilience
    "ANN001", # Type annotations relaxed for background tasks
    "ANN201", # Return type relaxed for background tasks
    "ANN202", # Return type relaxed for inner functions
    "S110",   # try-except-pass for resilience
]

# OpenWebUI client
"backend/api/openwebui_client.py" = [
    "E501",   # Line length relaxed for API calls
    "E722",   # Bare except for API error handling
    "BLE001", # Blind except for API error handling
    "B904",   # Raise from not required for API errors
    "ANN001", # Type annotations relaxed
    "ANN201", # Return type relaxed
    "ANN204", # Return type relaxed for special methods
    "D102",   # Docstrings not required for client methods
    "PLC0415", # Import inside function OK (lazy loading)
]

# Django settings
"backend/backend/settings*.py" = [
    "E501",   # Line length relaxed for Django settings
]

# Test files can have some relaxed rules
"backend/tests/**/*.py" = [
    "S101",   # Use of assert
    "S105",   # Hardcoded password assignment OK in tests
    "S106",   # Hardcoded passwords OK in tests
    "S107",   # Hardcoded token defaults OK in tests
    "PLR2004", # Magic value in comparison
    "ANN",    # Type annotations not required in tests
    "D",      # Docstrings not required in tests
    "ARG001", # Unused function argument (fixtures)
    "ARG002", # Unused method argument (fixtures)
    "PT004",  # Fixtures that don't return value (setup fixtures)
    "SLF001", # Private member access OK in tests
    "PLC0415", # Import inside function OK (fixtures with conditional imports)
]

# Scripts can print and have relaxed rules
"scripts/**/*.py" = [
    "T201",   # print() is fine in scripts
    "S603",   # subprocess without shell=True is fine for scripts
    "S607",   # Starting process with partial path (git) is fine
    "BLE001", # blind except acceptable in utility scripts
    "PLR0912", # many branches OK for main functions
    "PLR0915", # many statements OK for main functions
    "PLR2004", # magic values OK in scripts
    "D212",   # multi-line docstring format
    "D415",   # docstring punctuation
    "TRY003", # long exception messages OK
    "EM102",  # f-strings in exceptions OK
    "SLF001", # private member access OK (for _make_request)
    "ANN201", # return type annotations not required
    "PLC0415", # import in function OK (traceback for errors)
]

# Modernization scripts have additional relaxed rules (analyzing legacy code)
"scripts/modernize/*.py" = [
    "PTH123", # open() is fine (Path.open() not always needed)
    "PLR2004", # magic values OK (complexity thresholds, file sizes)
    "S110",   # try-except-pass OK (graceful degradation for analysis)
    "DTZ005", # datetime without tz OK for reports
    "PLC0415", # import in function OK (conditional imports)
    "PLW1510", # subprocess.run check parameter not always needed
    "ANN201", # return type annotations not required
    "E501",   # line length can exceed for report generation
]

[lint.pydocstyle]
# Use Google-style docstrings
convention = "google"

[lint.isort]
# isort configuration
known-first-party = ["scripts", "src"]
force-single-line = false
lines-after-imports = 2

[format]
# Format configuration
quote-style = "single"
indent-style = "space"
skip-magic-trailing-comma = false
line-ending = "lf"
